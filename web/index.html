<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LINUXGROOVE Market Trends</title>
  <link rel="icon" type="image/x-icon" href="favicon.ico" />
  <link rel="icon" type="image/png" sizes="192x192" href="favicon-192.png" />
  <link rel="apple-touch-icon" href="favicon-192.png" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Ubuntu:ital,wght@0,300;0,400;0,500;0,700;1,400&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    /* ── Design tokens ── */
    :root {
      --bg:           #0f1117;
      --surface:      #1a1d26;
      --surface2:     #22263a;
      --border:       #2e3348;
      --text:         #e2e8f0;
      --text-muted:   #8892a4;
      --accent:       #7c6af9;
      --accent-hover: #9785ff;

      /* Source colours */
      --steam-h:      210; /* blue family */
      --sc-h:         145; /* green family */
      --dap-h:        30;  /* orange family */

      /* Per-source, per-OS colours (HSL) */
      --steam-linux:       hsl(210, 85%, 60%);
      --steam-windows:     hsl(210, 55%, 75%);
      --steam-mac:         hsl(210, 40%, 45%);
      --sc-linux:          hsl(145, 65%, 50%);
      --sc-windows:        hsl(145, 45%, 68%);
      --sc-mac:            hsl(145, 40%, 38%);
      --dap-linux:         hsl(30,  85%, 58%);
      --dap-windows:       hsl(30,  60%, 74%);
      --dap-mac:           hsl(30,  45%, 42%);
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: "Ubuntu", system-ui, -apple-system, sans-serif;
      font-size: 14px;
      line-height: 1.6;
      min-height: 100vh;
    }

    /* ── Layout ── */
    .app {
      max-width: 1100px;
      margin: 0 auto;
      padding: 24px 16px 48px;
    }

    /* ── Header ── */
    header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 28px;
    }
    .logo { width: 48px; height: 48px; flex-shrink: 0; }
    header h1 {
      font-size: 22px;
      font-weight: 700;
      letter-spacing: -0.3px;
    }
    header p {
      color: var(--text-muted);
      font-size: 13px;
    }
    .last-updated {
      margin-left: auto;
      text-align: right;
      color: var(--text-muted);
      font-size: 12px;
    }

    /* ── Controls ── */
    .controls {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 16px 20px;
      margin-bottom: 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      align-items: flex-start;
    }

    .control-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .control-group label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: var(--text-muted);
    }

    .btn-row { display: flex; gap: 6px; flex-wrap: wrap; }

    /* Timeframe buttons */
    .btn-time {
      padding: 5px 14px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: var(--surface2);
      color: var(--text);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: background .15s, border-color .15s, color .15s;
    }
    .btn-time:hover { border-color: var(--accent); color: var(--accent-hover); }
    .btn-time.active {
      background: var(--accent);
      border-color: var(--accent);
      color: #fff;
    }

    /* Reset / Share action buttons */
    .btn-action {
      padding: 5px 14px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: var(--surface2);
      color: var(--text-muted);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: background .15s, border-color .15s, color .15s;
    }
    .btn-action:hover { border-color: var(--accent); color: var(--text); }
    .btn-action.share {
      background: var(--accent);
      border-color: var(--accent);
      color: #fff;
    }
    .btn-action.share:hover { background: var(--accent-hover); border-color: var(--accent-hover); }
    .btn-action:disabled { opacity: 0.6; cursor: default; }

    /* Source / OS toggle chips */
    .chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 5px 12px;
      border-radius: 20px;
      border: 1px solid var(--border);
      background: var(--surface2);
      color: var(--text-muted);
      font-size: 13px;
      cursor: pointer;
      transition: opacity .15s, border-color .15s, color .15s;
      user-select: none;
      opacity: 0.4;
    }
    .chip:hover { opacity: 0.7; border-color: var(--accent); color: var(--text); }
    .chip.active {
      opacity: 1;
      color: var(--text);
      border-color: var(--chip-color, var(--accent));
    }
    .chip-dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
      filter: grayscale(1);
      transition: filter .15s;
    }
    .chip.active .chip-dot { filter: none; }

    /* ── Chart card ── */
    .chart-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .chart-wrap { position: relative; height: 380px; }

    .chart-card h2 {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.6px;
      margin-bottom: 4px;
    }
    .chart-subtitle {
      font-size: 12px;
      color: var(--text-muted);
      opacity: 0.75;
      margin-bottom: 14px;
    }

    .no-data {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      font-size: 15px;
    }

    /* ── Stats table ── */
    .stats-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .stats-card h2 {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.6px;
      margin-bottom: 14px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    th {
      text-align: left;
      color: var(--text-muted);
      font-weight: 500;
      font-size: 12px;
      padding: 6px 10px;
      border-bottom: 1px solid var(--border);
    }
    td {
      padding: 8px 10px;
      border-bottom: 1px solid var(--border);
    }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: var(--surface2); }

    .source-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-weight: 500;
    }

    .pct-cell { font-variant-numeric: tabular-nums; }
    .trend-up   { color: #4ade80; }
    .trend-down { color: #f87171; }
    .trend-flat { color: var(--text-muted); }

    /* ── Info cards ── */
    .sources-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 14px;
      margin-bottom: 20px;
    }
    .source-info-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 16px;
    }
    .source-info-card h3 {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .source-info-card p {
      color: var(--text-muted);
      font-size: 12px;
      margin-bottom: 6px;
    }
    .source-info-card a {
      color: var(--accent);
      font-size: 12px;
      text-decoration: none;
    }
    .source-info-card a:hover { text-decoration: underline; }

    /* ── Section divider (Developer Surveys, etc.) ── */
    .section-divider {
      border-top: 1px solid var(--border);
      margin: 8px 0 20px;
      padding-top: 28px;
    }
    .section-divider h2 {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 6px;
    }
    .section-divider p {
      color: var(--text-muted);
      font-size: 13px;
    }

    /* ── Footer ── */
    footer {
      text-align: center;
      color: var(--text-muted);
      font-size: 12px;
      margin-top: 8px;
    }
    footer a { color: var(--accent); text-decoration: none; }
    footer a:hover { text-decoration: underline; }

    /* ── Loading overlay ── */
    #loading {
      position: fixed;
      inset: 0;
      background: var(--bg);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 14px;
      font-size: 16px;
      z-index: 999;
    }
    #loading.hidden { display: none; }
    .spinner {
      width: 36px; height: 36px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin .7s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ── Error banner ── */
    .error-banner {
      background: #2d1a1a;
      border: 1px solid #5c2a2a;
      border-radius: 8px;
      padding: 12px 16px;
      color: #fca5a5;
      font-size: 13px;
      margin-bottom: 16px;
    }
    .error-banner.hidden { display: none; }
    .no-data.hidden { display: none; }

    @media (max-width: 640px) {
      header { flex-wrap: wrap; }
      .last-updated { margin-left: 0; text-align: left; }
    }
  </style>
</head>
<body>

<!-- Loading overlay -->
<div id="loading">
  <div class="spinner"></div>
  <span>Loading data…</span>
</div>

<div class="app">
  <header>
    <img class="logo" src="linuxgroove.png" alt="LINUXGROOVE" />
    <div>
      <h1>LINUXGROOVE</h1>
      <p>Market Trends</p>
    </div>
    <div class="last-updated" id="last-updated"></div>
  </header>

  <!-- Error banner (hidden by default) -->
  <div class="error-banner hidden" id="error-banner"></div>

  <!-- Controls -->
  <div class="controls">
    <!-- Timeframe -->
    <div class="control-group">
      <label>Timeframe</label>
      <div class="btn-row" id="timeframe-btns">
        <button class="btn-time" data-months="12">1Y</button>
        <button class="btn-time" data-months="36">3Y</button>
        <button class="btn-time" data-months="60">5Y</button>
        <button class="btn-time active" data-months="0">Max</button>
      </div>
    </div>

    <!-- Data sources -->
    <div class="control-group" id="source-group">
      <label>Data Sources</label>
      <div class="btn-row" id="source-chips"></div>
    </div>

    <!-- OS types -->
    <div class="control-group">
      <label>Operating Systems</label>
      <div class="btn-row" id="os-chips">
        <span class="chip active" data-os="linux" style="--chip-color: hsl(145,65%,50%)">
          <span class="chip-dot" style="background:hsl(145,65%,50%)"></span>Linux
        </span>
        <span class="chip" data-os="windows" style="--chip-color: hsl(210,55%,75%)">
          <span class="chip-dot" style="background:hsl(210,55%,75%)"></span>Windows
        </span>
        <span class="chip" data-os="mac" style="--chip-color: hsl(30,60%,62%)">
          <span class="chip-dot" style="background:hsl(30,60%,62%)"></span>macOS
        </span>
        <span class="chip" data-os="wsl" style="--chip-color: hsl(185,65%,48%)">
          <span class="chip-dot" style="background:hsl(185,65%,48%)"></span>WSL
        </span>
      </div>
    </div>

    <!-- Reset / Share -->
    <div style="margin-left:auto; align-self:flex-end; display:flex; gap:8px;">
      <button class="btn-action" id="btn-reset">Reset</button>
      <button class="btn-action share" id="btn-share">Share</button>
    </div>
  </div>

  <!-- Main chart -->
  <div class="chart-card">
    <h2>Market Share Over Time</h2>
    <div class="chart-wrap">
      <canvas id="chart"></canvas>
      <div class="no-data hidden" id="no-data">No data to display for this selection.</div>
    </div>
  </div>

  <!-- Gap / delta chart (shown when a comparison OS is selected alongside Linux) -->
  <div class="chart-card" id="gap-chart-card" style="display:none">
    <h2>Linux Gap Analysis</h2>
    <p class="chart-subtitle">Percentage-point difference between Linux and each selected platform (Linux − Platform). Negative = Linux trails; trending upward = Linux gaining ground.</p>
    <div class="chart-wrap">
      <canvas id="gap-chart"></canvas>
      <div class="no-data hidden" id="gap-no-data">No gap data available for this selection.</div>
    </div>
  </div>

  <!-- Stats table -->
  <div class="stats-card">
    <h2>Latest Readings</h2>
    <table id="stats-table">
      <thead>
        <tr id="stats-head-row">
          <th>Source</th>
          <th>Period</th>
          <th>Linux</th>
          <th>Windows</th>
          <th>macOS</th>
          <th>MoM Change (Linux)</th>
        </tr>
      </thead>
      <tbody id="stats-body"></tbody>
    </table>
  </div>

  <!-- Source info cards -->
  <div class="sources-grid" id="sources-grid"></div>

  <!-- ── Developer Surveys section ── -->
  <div class="section-divider" id="survey-section" style="display:none">
    <h2>Developer Surveys</h2>
    <p>Self-reported platform preferences from developer community surveys. Reflects developer adoption rather than general desktop or web traffic share.</p>
  </div>

  <!-- Survey controls (source chips shown only when >1 survey; OS chips always shown) -->
  <div class="controls" id="survey-controls" style="display:none">
    <div class="control-group" id="survey-source-group" style="display:none">
      <label>Surveys</label>
      <div class="btn-row" id="survey-source-chips"></div>
    </div>
    <div class="control-group">
      <label>Operating Systems</label>
      <div class="btn-row" id="survey-os-chips">
        <span class="chip active" data-survey-os="linux" style="--chip-color: hsl(145,65%,50%)">
          <span class="chip-dot" style="background:hsl(145,65%,50%)"></span>Linux
        </span>
        <span class="chip active" data-survey-os="windows" style="--chip-color: hsl(210,55%,75%)">
          <span class="chip-dot" style="background:hsl(210,55%,75%)"></span>Windows
        </span>
        <span class="chip" data-survey-os="mac" style="--chip-color: hsl(30,60%,62%)">
          <span class="chip-dot" style="background:hsl(30,60%,62%)"></span>macOS
        </span>
        <span class="chip active" data-survey-os="wsl" style="--chip-color: hsl(185,65%,48%)">
          <span class="chip-dot" style="background:hsl(185,65%,48%)"></span>WSL
        </span>
      </div>
    </div>
  </div>

  <div class="chart-card" id="survey-chart-card" style="display:none">
    <h2>OS Share — Developer Surveys</h2>
    <div class="chart-wrap">
      <canvas id="survey-chart"></canvas>
      <div class="no-data hidden" id="survey-no-data">No data to display for this selection.</div>
    </div>
  </div>

  <div class="chart-card" id="survey-gap-chart-card" style="display:none">
    <h2>Linux Gap Analysis — Developer Surveys</h2>
    <p class="chart-subtitle">Percentage-point difference between Linux and each selected platform (Linux − Platform). Negative = Linux trails; trending upward = Linux gaining ground.</p>
    <div class="chart-wrap">
      <canvas id="survey-gap-chart"></canvas>
      <div class="no-data hidden" id="survey-gap-no-data">No gap data available for this selection.</div>
    </div>
  </div>

  <div class="stats-card" id="survey-stats-card" style="display:none">
    <h2>Latest Readings — Developer Surveys</h2>
    <table id="survey-stats-table">
      <thead><tr id="survey-stats-head-row"></tr></thead>
      <tbody id="survey-stats-body"></tbody>
    </table>
  </div>

  <footer>
    <p>Data aggregated from public sources. See each source for methodology. &nbsp;|&nbsp;
    <a href="https://trends.linuxgroove.com" target="_blank">trends.linuxgroove.com</a> &nbsp;|&nbsp;
    <a href="https://github.com/kenvandine/trends.linuxgroove.com" target="_blank">GitHub</a></p>
    <p style="margin-top:6px">Created by <a href="https://github.com/kenvandine" target="_blank" rel="noopener">Ken VanDine</a></p>
  </footer>
</div>

<script>
// Apply Ubuntu to all Chart.js text globally
Chart.defaults.font.family = '"Ubuntu", system-ui, sans-serif';

/* ═══════════════════════════════════════════════════════════════════
   CONFIG — edit here to add new sources or OS types in future
   ═══════════════════════════════════════════════════════════════════ */
const SOURCE_CONFIG = {
  Steam: {
    label: "Steam",
    colors: {
      linux:   "hsl(210,85%,60%)",
      windows: "hsl(210,55%,75%)",
      mac:     "hsl(210,40%,48%)",
    },
    chipColor: "hsl(210,85%,60%)",
  },
  StatCounter: {
    label: "StatCounter",
    colors: {
      linux:   "hsl(145,65%,50%)",
      windows: "hsl(145,45%,68%)",
      mac:     "hsl(145,40%,38%)",
    },
    chipColor: "hsl(145,65%,50%)",
  },
  DAP: {
    label: "DAP (US Gov)",
    colors: {
      linux:   "hsl(30,85%,58%)",
      windows: "hsl(30,60%,74%)",
      mac:     "hsl(30,45%,42%)",
    },
    chipColor: "hsl(30,85%,58%)",
  },
  Cloudflare: {
    label: "Cloudflare Radar",
    colors: {
      linux:   "hsl(270,70%,62%)",
      windows: "hsl(270,45%,75%)",
      mac:     "hsl(270,40%,45%)",
    },
    chipColor: "hsl(270,70%,62%)",
  },
  StackOverflow: {
    label: "Stack Overflow Survey",
    survey: true,
    colors: {
      linux:   "hsl(15,80%,55%)",
      windows: "hsl(15,55%,72%)",
      mac:     "hsl(15,45%,40%)",
      wsl:     "hsl(185,65%,48%)",
    },
    chipColor: "hsl(15,80%,55%)",
  },
  JetBrains: {
    label: "JetBrains Survey",
    survey: true,
    colors: {
      linux:   "hsl(340,70%,58%)",
      windows: "hsl(340,45%,72%)",
      mac:     "hsl(340,40%,44%)",
    },
    chipColor: "hsl(340,70%,58%)",
  },
};

const OS_CONFIG = {
  linux:   { label: "Linux",   field: "linux_share",   dash: [] },
  windows: { label: "Windows", field: "windows_share", dash: [6, 3] },
  mac:     { label: "macOS",   field: "mac_share",     dash: [2, 3] },
  wsl:     { label: "WSL",     field: "wsl_share",     dash: [4, 2] },
};

/* ═══════════════════════════════════════════════════════════════════
   STATE
   ═══════════════════════════════════════════════════════════════════ */
let allData            = [];   // raw data points from combined.json
let manifest           = {};   // manifest.json content
let chart              = null; // Chart.js instance (market)
let gapChart           = null; // Chart.js instance (market gap)
let surveyChart        = null; // Chart.js instance (developer surveys)
let surveyGapChart     = null; // Chart.js instance (developer survey gap)
let activeMonths       = 0;    // 0 = all time
let activeSources      = new Set(); // active market sources
let activeSurveySources = new Set(); // active survey sources
let activeOSes         = new Set(["linux"]);
let activeSurveyOSes   = new Set(["linux", "windows", "wsl"]);

/* ═══════════════════════════════════════════════════════════════════
   INIT
   ═══════════════════════════════════════════════════════════════════ */
async function init() {
  try {
    // Probe for the data directory — works regardless of where the HTTP
    // server is rooted (project root, web/ subdir, etc.)
    const base = await detectDataBase();

    // Load manifest first (for source metadata)
    try {
      const mRes = await fetch(`${base}/manifest.json`);
      if (mRes.ok) manifest = await mRes.json();
    } catch (_) { /* manifest optional */ }

    // Load combined data
    const dRes = await fetch(`${base}/combined.json`);
    if (!dRes.ok) throw new Error(`Could not load combined.json (${dRes.status})`);
    const combined = await dRes.json();
    allData = combined.data || [];

    if (combined.metadata?.last_updated) {
      document.getElementById("last-updated").textContent =
        "Updated: " + formatDate(combined.metadata.last_updated);
    }

    buildSourceChips();
    buildSurveySourceChips();
    buildSourceInfoCards();
    buildChart();
    buildGapChart();
    buildSurveyChart();
    buildSurveyGapChart();
    applyUrlParams();
    render();

  } catch (err) {
    showError(`Failed to load data: ${err.message}. Run the data collection script first, then serve via HTTP from either the project root or the web/ directory.`);
  } finally {
    document.getElementById("loading").classList.add("hidden");
  }
}

async function detectDataBase() {
  // Try candidate paths in preference order.
  // "data" works in both cases: via the web/data symlink when serving from
  // the web/ directory, and directly when serving from the project root.
  // "../data" is the fallback for serving from project root without the symlink.
  for (const candidate of ["data", "../data"]) {
    try {
      const r = await fetch(`${candidate}/combined.json`, { method: "HEAD" });
      if (r.ok) return candidate;
    } catch (_) { /* try next */ }
  }
  return "../data"; // fall through — fetch will produce a clear error
}

/* ═══════════════════════════════════════════════════════════════════
   BUILD UI COMPONENTS
   ═══════════════════════════════════════════════════════════════════ */
function buildSourceChips() {
  // Only market (non-survey) sources
  const sourcesInData = [...new Set(allData.map(d => d.source))]
    .filter(s => !SOURCE_CONFIG[s]?.survey)
    .sort();
  activeSources = new Set(sourcesInData);

  const container = document.getElementById("source-chips");
  container.innerHTML = "";

  sourcesInData.forEach(src => {
    const cfg = SOURCE_CONFIG[src] || { label: src, chipColor: "#888" };
    const chip = document.createElement("span");
    chip.className = "chip active";
    chip.dataset.source = src;
    chip.style.setProperty("--chip-color", cfg.chipColor);
    chip.innerHTML = `
      <span class="chip-dot" style="background:${cfg.chipColor}"></span>${cfg.label}`;
    container.appendChild(chip);
  });
}

function buildSurveySourceChips() {
  const sourcesInData = [...new Set(allData.map(d => d.source))]
    .filter(s => SOURCE_CONFIG[s]?.survey)
    .sort();
  activeSurveySources = new Set(sourcesInData);

  if (sourcesInData.length === 0) return;

  // Always show section, controls bar, and chart card when survey data exists
  document.getElementById("survey-section").style.display = "";
  document.getElementById("survey-controls").style.display = "";
  document.getElementById("survey-chart-card").style.display = "";
  document.getElementById("survey-stats-card").style.display = "";

  // Source chip group only needed when there's more than one survey
  if (sourcesInData.length > 1) {
    document.getElementById("survey-source-group").style.display = "";
    const container = document.getElementById("survey-source-chips");
    container.innerHTML = "";
    sourcesInData.forEach(src => {
      const cfg = SOURCE_CONFIG[src] || { label: src, chipColor: "#888" };
      const chip = document.createElement("span");
      chip.className = "chip active";
      chip.dataset.surveySource = src;
      chip.style.setProperty("--chip-color", cfg.chipColor);
      chip.innerHTML = `
        <span class="chip-dot" style="background:${cfg.chipColor}"></span>${cfg.label}`;
      container.appendChild(chip);
    });
  }

  // Hide OS chips for which no survey data exists
  const surveyData = allData.filter(d => SOURCE_CONFIG[d.source]?.survey);
  document.querySelectorAll(".chip[data-survey-os]").forEach(chip => {
    const osKey = chip.dataset.surveyOs;
    const field = OS_CONFIG[osKey]?.field;
    const hasData = field && surveyData.some(d => d[field] != null);
    if (!hasData) chip.style.display = "none";
  });
}

function buildSourceInfoCards() {
  const grid = document.getElementById("sources-grid");
  grid.innerHTML = "";

  const sourcesInData = [...new Set(allData.map(d => d.source))];
  sourcesInData.forEach(src => {
    const meta = manifest?.sources?.[src.toLowerCase()] || {};
    const cfg  = SOURCE_CONFIG[src] || { chipColor: "#888", label: src };
    const card = document.createElement("div");
    card.className = "source-info-card";
    card.innerHTML = `
      <h3>
        <span class="chip-dot" style="background:${cfg.chipColor};width:10px;height:10px;border-radius:50%;display:inline-block;"></span>
        ${meta.name || src}
      </h3>
      <p>${meta.description || ""}</p>
      ${meta.methodology ? `<p><em>${meta.methodology}</em></p>` : ""}
      ${meta.url ? `<a href="${meta.url}" target="_blank" rel="noopener">${meta.url}</a>` : ""}
    `;
    grid.appendChild(card);
  });
}

// ── Chart factories (shared config) ──────────────────────────────
function createLineChart(canvasId) {
  const ctx = document.getElementById(canvasId).getContext("2d");
  return new Chart(ctx, {
    type: "line",
    data: { labels: [], datasets: [] },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: "index", intersect: false },
      plugins: {
        legend: {
          display: true,
          position: "top",
          labels: { color: "#8892a4", boxWidth: 20, padding: 16,
                    font: { size: 12 }, usePointStyle: true, pointStyleWidth: 16 },
        },
        tooltip: {
          backgroundColor: "#1a1d26", borderColor: "#2e3348", borderWidth: 1,
          titleColor: "#e2e8f0", bodyColor: "#8892a4",
          callbacks: {
            label: ctx => ` ${ctx.dataset.label}: ${ctx.parsed.y?.toFixed(2) ?? "N/A"}%`,
          },
        },
      },
      scales: {
        x: { grid: { color: "#1e2230" }, ticks: { color: "#8892a4", maxTicksLimit: 18, maxRotation: 45 } },
        y: { grid: { color: "#1e2230" }, ticks: { color: "#8892a4", callback: v => v + "%" }, min: 0 },
      },
    },
  });
}

function createGapChart(canvasId) {
  const ctx = document.getElementById(canvasId).getContext("2d");
  return new Chart(ctx, {
    type: "line",
    data: { labels: [], datasets: [] },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: "index", intersect: false },
      plugins: {
        legend: {
          display: true,
          position: "top",
          labels: { color: "#8892a4", boxWidth: 20, padding: 16,
                    font: { size: 12 }, usePointStyle: true, pointStyleWidth: 16 },
        },
        tooltip: {
          backgroundColor: "#1a1d26", borderColor: "#2e3348", borderWidth: 1,
          titleColor: "#e2e8f0", bodyColor: "#8892a4",
          callbacks: {
            label: ctx => {
              const v = ctx.parsed.y;
              if (v == null) return ` ${ctx.dataset.label}: N/A`;
              return ` ${ctx.dataset.label}: ${v > 0 ? "+" : ""}${v.toFixed(2)} pp`;
            },
          },
        },
      },
      scales: {
        x: { grid: { color: "#1e2230" }, ticks: { color: "#8892a4", maxTicksLimit: 18, maxRotation: 45 } },
        y: { grid: { color: "#1e2230" }, ticks: { color: "#8892a4", callback: v => (v > 0 ? "+" : "") + v + " pp" } },
      },
    },
  });
}

function buildChart()          { chart          = createLineChart("chart"); }
function buildGapChart()       { gapChart       = createGapChart("gap-chart"); }
function buildSurveyChart()    { surveyChart    = createLineChart("survey-chart"); }
function buildSurveyGapChart() { surveyGapChart = createGapChart("survey-gap-chart"); }

/* ═══════════════════════════════════════════════════════════════════
   RENDER
   ═══════════════════════════════════════════════════════════════════ */
function render() {
  // ── Market charts ──
  const filtered = filterData();
  const labels   = buildLabels(filtered);
  const datasets = buildDatasets(filtered, labels);

  const noData = document.getElementById("no-data");
  noData.classList.toggle("hidden", datasets.length > 0);
  chart.data.labels   = labels;
  chart.data.datasets = datasets;
  chart.update();

  renderGapChart(filtered, labels, gapChart, "gap-chart-card", "gap-no-data");
  renderStats(filtered, "stats-head-row", "stats-body", activeOSes);

  // ── Developer Survey charts ──
  const surveyFiltered = filterSurveyData();
  const surveyLabels   = buildLabels(surveyFiltered);
  const surveyDatasets = buildDatasets(surveyFiltered, surveyLabels, activeSurveyOSes);

  const surveyNoData = document.getElementById("survey-no-data");
  surveyNoData.classList.toggle("hidden", surveyDatasets.length > 0);
  surveyChart.data.labels   = surveyLabels;
  surveyChart.data.datasets = surveyDatasets;
  surveyChart.update();

  renderGapChart(surveyFiltered, surveyLabels, surveyGapChart, "survey-gap-chart-card", "survey-gap-no-data", activeSurveyOSes);
  renderStats(surveyFiltered, "survey-stats-head-row", "survey-stats-body", activeSurveyOSes);
}

function filterData() {
  let data = allData.filter(d => activeSources.has(d.source) && !SOURCE_CONFIG[d.source]?.survey);
  return applyTimeframe(data);
}

function filterSurveyData() {
  let data = allData.filter(d => activeSurveySources.has(d.source) && SOURCE_CONFIG[d.source]?.survey);
  return applyTimeframe(data);
}

function applyTimeframe(data) {
  if (activeMonths > 0) {
    const cutoff = new Date();
    cutoff.setMonth(cutoff.getMonth() - activeMonths);
    const cutoffStr = cutoff.toISOString().slice(0, 7);
    data = data.filter(d => d.date.slice(0, 7) >= cutoffStr);
  }
  return data;
}

function buildLabels(data) {
  // Unique sorted dates as "YYYY-MM"
  return [...new Set(data.map(d => d.date.slice(0, 7)))].sort();
}

function buildDatasets(data, labels, osSet = activeOSes) {
  const datasets = [];

  // Group data by source
  const bySource = {};
  data.forEach(d => {
    if (!bySource[d.source]) bySource[d.source] = {};
    bySource[d.source][d.date.slice(0, 7)] = d;
  });

  Object.entries(bySource).forEach(([src, byDate]) => {
    const cfg = SOURCE_CONFIG[src] || { label: src, colors: { linux: "#888", windows: "#aaa", mac: "#ccc" } };

    osSet.forEach(osKey => {
      const osCfg = OS_CONFIG[osKey];
      if (!osCfg) return;

      // Check if any data point for this source has this field
      const hasField = Object.values(byDate).some(d => d[osCfg.field] != null);
      if (!hasField) return;

      const color = cfg.colors[osKey] || "#888";
      const dataArr = labels.map(lbl => {
        const pt = byDate[lbl];
        return pt?.[osCfg.field] ?? null;
      });

      datasets.push({
        label: `${cfg.label} — ${osCfg.label}`,
        data: dataArr,
        borderColor: color,
        backgroundColor: color.replace("hsl", "hsla").replace(")", ",0.12)"),
        pointRadius: labels.length > 60 ? 0 : 2,
        pointHoverRadius: 4,
        borderWidth: 2,
        borderDash: osCfg.dash,
        tension: 0.3,
        spanGaps: true,
      });
    });
  });

  return datasets;
}

function renderGapChart(filtered, labels, chartInst, cardId, noDataId, osSet = activeOSes) {
  // Only show when Linux is selected alongside at least one comparison OS
  const compareOSes = [];
  if (osSet.has("linux") && osSet.has("windows")) compareOSes.push("windows");
  if (osSet.has("linux") && osSet.has("mac"))     compareOSes.push("mac");

  const gapCard   = document.getElementById(cardId);
  const gapNoData = document.getElementById(noDataId);

  if (compareOSes.length === 0) {
    gapCard.style.display = "none";
    return;
  }
  gapCard.style.display = "";

  // Group data by source
  const bySource = {};
  filtered.forEach(d => {
    if (!bySource[d.source]) bySource[d.source] = {};
    bySource[d.source][d.date.slice(0, 7)] = d;
  });

  const datasets = [];

  Object.entries(bySource).forEach(([src, byDate]) => {
    const cfg = SOURCE_CONFIG[src] || { label: src, colors: {} };

    compareOSes.forEach(osKey => {
      const osCfg = OS_CONFIG[osKey];
      const hasData = Object.values(byDate).some(
        d => d.linux_share != null && d[osCfg.field] != null
      );
      if (!hasData) return;

      // Use the source's linux color with the comparison OS's dash style so it
      // stays visually consistent with the main chart's line-style conventions.
      const linuxColor = cfg.colors.linux || cfg.colors[osKey] || "#888";
      const dash = osCfg.dash; // [] for windows([6,3]) / [2,3] for mac

      const dataArr = labels.map(lbl => {
        const pt = byDate[lbl];
        if (!pt || pt.linux_share == null || pt[osCfg.field] == null) return null;
        return pt.linux_share - pt[osCfg.field];
      });

      datasets.push({
        label: `${cfg.label} — Linux vs ${osCfg.label}`,
        data: dataArr,
        borderColor: linuxColor,
        backgroundColor: linuxColor.replace("hsl", "hsla").replace(")", ",0.08)"),
        pointRadius: labels.length > 60 ? 0 : 2,
        pointHoverRadius: 4,
        borderWidth: 2,
        borderDash: dash,
        tension: 0.3,
        spanGaps: true,
      });
    });
  });

  gapNoData.classList.toggle("hidden", datasets.length > 0);

  chartInst.data.labels   = labels;
  chartInst.data.datasets = datasets;
  chartInst.update();
}

// Renders a "latest readings" stats table.
// headRowId / bodyId: DOM ids for the thead tr and tbody.
// osSet: the active OS set for this section (controls delta columns).
// Auto-detects which OS columns have data, so WSL appears in survey tables
// without any extra configuration.
function renderStats(data, headRowId, bodyId, osSet) {
  const tbody   = document.getElementById(bodyId);
  const headRow = document.getElementById(headRowId);
  tbody.innerHTML = "";

  // Which OS fields actually have data in this dataset?
  const allOsKeys     = ["linux", "windows", "mac", "wsl"];
  const presentOsKeys = allOsKeys.filter(k => data.some(d => d[OS_CONFIG[k].field] != null));

  // Delta columns: comparison OSes selected alongside Linux.
  // WSL is excluded — it's a Linux subsystem, not a competing platform.
  const deltaOsKeys = presentOsKeys.filter(
    k => k !== "linux" && k !== "wsl" && osSet.has("linux") && osSet.has(k)
  );

  const totalCols = 2 + presentOsKeys.length + 1 + deltaOsKeys.length;

  headRow.innerHTML = `
    <th>Source</th>
    <th>Period</th>
    ${presentOsKeys.map(k => `<th>${OS_CONFIG[k].label}</th>`).join("")}
    <th>MoM Change (Linux)</th>
    ${deltaOsKeys.map(k => `<th>vs ${OS_CONFIG[k].label}</th>`).join("")}
  `;

  const sources = [...new Set(data.map(d => d.source))];

  sources.forEach(src => {
    const srcData = data.filter(d => d.source === src).sort((a, b) => a.date.localeCompare(b.date));
    if (srcData.length === 0) return;

    const latest = srcData[srcData.length - 1];
    const prev   = srcData.length > 1 ? srcData[srcData.length - 2] : null;
    const cfg    = SOURCE_CONFIG[src] || { chipColor: "#888", label: src };

    const linuxCur  = latest.linux_share ?? null;
    const linuxPrev = prev?.linux_share ?? null;

    const momDelta = (linuxCur != null && linuxPrev != null) ? (linuxCur - linuxPrev) : null;
    const momClass = momDelta == null ? "trend-flat" : momDelta > 0 ? "trend-up" : "trend-down";
    const momStr   = momDelta == null ? "—" : (momDelta > 0 ? "+" : "") + momDelta.toFixed(2) + "%";

    const osCells = presentOsKeys.map(k =>
      `<td class="pct-cell">${pctCell(latest[OS_CONFIG[k].field] ?? null)}</td>`
    ).join("");

    const deltaCells = deltaOsKeys.map(k => {
      const field = OS_CONFIG[k].field;
      return `<td class="pct-cell">${ppDeltaCell(linuxCur, latest[field] ?? null, linuxPrev, prev?.[field] ?? null)}</td>`;
    }).join("");

    const row = document.createElement("tr");
    row.innerHTML = `
      <td>
        <span class="source-badge">
          <span style="width:10px;height:10px;border-radius:50%;background:${cfg.chipColor};display:inline-block;flex-shrink:0;"></span>
          ${cfg.label}
        </span>
      </td>
      <td>${formatMonthLabel(latest.date.slice(0, 7))}</td>
      ${osCells}
      <td class="pct-cell ${momClass}">${momStr}</td>
      ${deltaCells}
    `;
    tbody.appendChild(row);
  });

  if (tbody.children.length === 0) {
    const row = document.createElement("tr");
    row.innerHTML = `<td colspan="${totalCols}" style="color:var(--text-muted);text-align:center">No data for current selection</td>`;
    tbody.appendChild(row);
  }
}

/* ═══════════════════════════════════════════════════════════════════
   RESET / SHARE
   ═══════════════════════════════════════════════════════════════════ */
function resetView() {
  // Restore all market sources
  activeSources = new Set([...document.querySelectorAll(".chip[data-source]")].map(c => c.dataset.source));
  document.querySelectorAll(".chip[data-source]").forEach(c => c.classList.add("active"));

  // Restore all survey sources
  activeSurveySources = new Set([...document.querySelectorAll(".chip[data-survey-source]")].map(c => c.dataset.surveySource));
  document.querySelectorAll(".chip[data-survey-source]").forEach(c => c.classList.add("active"));

  // Restore default survey OSes
  activeSurveyOSes = new Set(["linux", "windows", "wsl"]);
  document.querySelectorAll(".chip[data-survey-os]").forEach(c =>
    c.classList.toggle("active", activeSurveyOSes.has(c.dataset.surveyOs))
  );

  // Restore Linux-only OS
  activeOSes = new Set(["linux"]);
  document.querySelectorAll(".chip[data-os]").forEach(c =>
    c.classList.toggle("active", c.dataset.os === "linux")
  );

  // Restore Max timeframe
  activeMonths = 0;
  document.querySelectorAll(".btn-time").forEach(b =>
    b.classList.toggle("active", parseInt(b.dataset.months, 10) === 0)
  );

  history.replaceState(null, "", window.location.pathname);
  render();
}

function shareView() {
  const params = new URLSearchParams();
  params.set("sources", [...activeSources].join(","));
  params.set("os", [...activeOSes].join(","));
  params.set("months", activeMonths);
  params.set("survey_sources", [...activeSurveySources].join(","));
  params.set("survey_os", [...activeSurveyOSes].join(","));
  const url = `${window.location.origin}${window.location.pathname}?${params}`;

  const btn = document.getElementById("btn-share");
  navigator.clipboard.writeText(url).then(() => {
    btn.textContent = "Copied!";
    btn.disabled = true;
    setTimeout(() => { btn.textContent = "Share"; btn.disabled = false; }, 2000);
  }).catch(() => {
    prompt("Copy this link:", url);
  });
}

function applyUrlParams() {
  const params = new URLSearchParams(window.location.search);

  if (params.has("sources")) {
    const requested = new Set(params.get("sources").split(",").map(s => s.trim()).filter(Boolean));
    const valid = [...requested].filter(s => activeSources.has(s));
    if (valid.length > 0) {
      activeSources = new Set(valid);
      document.querySelectorAll(".chip[data-source]").forEach(c =>
        c.classList.toggle("active", activeSources.has(c.dataset.source))
      );
    }
  }

  if (params.has("os")) {
    const requested = new Set(params.get("os").split(",").map(s => s.trim()).filter(Boolean));
    const valid = [...requested].filter(os => OS_CONFIG[os]);
    if (valid.length > 0) {
      activeOSes = new Set(valid);
      document.querySelectorAll(".chip[data-os]").forEach(c =>
        c.classList.toggle("active", activeOSes.has(c.dataset.os))
      );
    }
  }

  if (params.has("months")) {
    const m = parseInt(params.get("months"), 10);
    if (!isNaN(m)) {
      activeMonths = m;
      document.querySelectorAll(".btn-time").forEach(b =>
        b.classList.toggle("active", parseInt(b.dataset.months, 10) === m)
      );
    }
  }

  if (params.has("survey_sources")) {
    const requested = new Set(params.get("survey_sources").split(",").map(s => s.trim()).filter(Boolean));
    const valid = [...requested].filter(s => activeSurveySources.has(s));
    if (valid.length > 0) {
      activeSurveySources = new Set(valid);
      document.querySelectorAll(".chip[data-survey-source]").forEach(c =>
        c.classList.toggle("active", activeSurveySources.has(c.dataset.surveySource))
      );
    }
  }

  if (params.has("survey_os")) {
    const requested = new Set(params.get("survey_os").split(",").map(s => s.trim()).filter(Boolean));
    const valid = [...requested].filter(os => OS_CONFIG[os]);
    if (valid.length > 0) {
      activeSurveyOSes = new Set(valid);
      document.querySelectorAll(".chip[data-survey-os]").forEach(c =>
        c.classList.toggle("active", activeSurveyOSes.has(c.dataset.surveyOs))
      );
    }
  }
}

/* ═══════════════════════════════════════════════════════════════════
   EVENT HANDLERS
   ═══════════════════════════════════════════════════════════════════ */
document.getElementById("timeframe-btns").addEventListener("click", e => {
  const btn = e.target.closest(".btn-time");
  if (!btn) return;
  document.querySelectorAll(".btn-time").forEach(b => b.classList.remove("active"));
  btn.classList.add("active");
  activeMonths = parseInt(btn.dataset.months, 10);
  render();
});

document.getElementById("source-chips").addEventListener("click", e => {
  const chip = e.target.closest(".chip[data-source]");
  if (chip) toggleSource(chip.dataset.source, chip);
});

document.getElementById("survey-source-chips").addEventListener("click", e => {
  const chip = e.target.closest(".chip[data-survey-source]");
  if (!chip) return;
  const src = chip.dataset.surveySource;
  if (activeSurveySources.has(src)) {
    if (activeSurveySources.size === 1) return; // keep at least one
    activeSurveySources.delete(src);
    chip.classList.remove("active");
  } else {
    activeSurveySources.add(src);
    chip.classList.add("active");
  }
  render();
});

document.getElementById("survey-os-chips").addEventListener("click", e => {
  const chip = e.target.closest(".chip[data-survey-os]");
  if (!chip) return;
  const os = chip.dataset.surveyOs;
  if (activeSurveyOSes.has(os)) {
    if (activeSurveyOSes.size === 1) return; // keep at least one
    activeSurveyOSes.delete(os);
    chip.classList.remove("active");
  } else {
    activeSurveyOSes.add(os);
    chip.classList.add("active");
  }
  render();
});

document.getElementById("os-chips").addEventListener("click", e => {
  const chip = e.target.closest(".chip[data-os]");
  if (!chip) return;
  const os = chip.dataset.os;
  if (activeOSes.has(os)) {
    if (activeOSes.size === 1) return; // keep at least one
    activeOSes.delete(os);
    chip.classList.remove("active");
  } else {
    activeOSes.add(os);
    chip.classList.add("active");
  }
  render();
});

function toggleSource(src, chip) {
  if (activeSources.has(src)) {
    if (activeSources.size === 1) return; // keep at least one
    activeSources.delete(src);
    chip.classList.remove("active");
  } else {
    activeSources.add(src);
    chip.classList.add("active");
  }
  render();
}

document.getElementById("btn-reset").addEventListener("click", resetView);
document.getElementById("btn-share").addEventListener("click", shareView);

/* ═══════════════════════════════════════════════════════════════════
   HELPERS
   ═══════════════════════════════════════════════════════════════════ */
function pctCell(val) {
  return val != null ? val.toFixed(2) + "%" : "<span style='color:var(--text-muted)'>—</span>";
}

// Shows the month-over-month change in the Linux vs comparison gap (Δ pp).
// Positive = gap narrowed (Linux gaining ground) → green.
// Negative = gap widened (Linux losing ground) → red.
function ppDeltaCell(linuxCur, otherCur, linuxPrev, otherPrev) {
  if (linuxCur == null || otherCur == null || linuxPrev == null || otherPrev == null)
    return "<span style='color:var(--text-muted)'>—</span>";
  const change = (linuxCur - otherCur) - (linuxPrev - otherPrev);
  const cls  = change > 0 ? "trend-up" : change < 0 ? "trend-down" : "trend-flat";
  const sign = change > 0 ? "+" : "";
  return `<span class="${cls}">${sign}${change.toFixed(2)} pp</span>`;
}

function formatMonthLabel(ym) {
  const [year, month] = ym.split("-");
  const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  return `${months[parseInt(month, 10) - 1]} ${year}`;
}

function formatDate(iso) {
  try {
    return new Date(iso).toLocaleDateString("en-US", { year: "numeric", month: "short", day: "numeric" });
  } catch { return iso; }
}

function showError(msg) {
  const el = document.getElementById("error-banner");
  el.textContent = msg;
  el.classList.remove("hidden");
}

/* ═══════════════════════════════════════════════════════════════════
   BOOT
   ═══════════════════════════════════════════════════════════════════ */
init();
</script>
</body>
</html>
